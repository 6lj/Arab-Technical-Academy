<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>شهاداتي - أكاديمية العرب التقنية</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <script src="/js/certificate-generator.js"></script>
  <style>
        body { font-family: 'Cairo', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <%- include('partials/header') %>
    
    <div class="container mx-auto px-4 py-8">
        <h1 class="text-4xl font-bold mb-8">شهاداتي</h1>
        
        <% if (certificates.length === 0) { %>
            <div class="bg-white rounded-lg shadow p-12 text-center">
                <div class="mb-4">
                    <img src="https://i.ibb.co/x8sYjYyK/out.png" alt="أكاديمية العرب التقنية" class="w-16 h-16 object-contain mx-auto">
                </div>
                <p class="text-xl text-gray-600 mb-4">لم تحصل على شهادات بعد</p>
                <p class="text-gray-500 mb-6">أكمل دوراتك للحصول على شهادات معتمدة</p>
                <a href="/dashboard" class="inline-block bg-indigo-600 text-white px-6 py-3 rounded-lg hover:bg-indigo-700 transition">
                    عودة للدورات
                </a>
            </div>
        <% } else { %>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <% certificates.forEach(cert => { %>
                    <div class="bg-white rounded-lg shadow-lg overflow-hidden hover:shadow-xl transition" data-cert-id="<%= cert.id %>">
                        <div class="relative">
                            <img src="<%= cert.thumbnail_url || cert.certificate_image_url %>" 
                                 alt="<%= cert.courseName %>" 
                                 class="w-full h-48 object-cover">
                            <div class="absolute top-2 left-2 bg-green-500 text-white px-3 py-1 rounded-full text-sm">
                                ✓ مكتمل
                            </div>
                        </div>
                        
                        <div class="p-6">
                            <h3 class="text-xl font-bold mb-2"><%= cert.courseName %></h3>
                            <div class="text-gray-600 text-sm mb-4">
                                <p>الدرجة: <%= cert.grade %>/100</p>
                                <p>تاريخ الإصدار: <%= cert.issueDate %></p>
                                <p class="text-xs text-gray-400 mt-2">معرف الشهادة: <%= cert.id %></p>
                            </div>
                            
                            <div class="flex gap-2 mb-2">
                                <a href="/certificate/<%= cert.id %>/download" 
                                   class="flex-1 bg-indigo-600 text-white text-center py-2 rounded-lg hover:bg-indigo-700 transition text-sm">
                                    تحميل PDF
                                </a>
                                <a href="/verify/<%= cert.id %>" target="_blank"
                                   class="flex-1 bg-gray-200 text-gray-700 text-center py-2 rounded-lg hover:bg-gray-300 transition text-sm">
                                    صفحة التحقق
                                </a>
                            </div>
                            
                            <a href="https://www.linkedin.com/profile/add?startTask=CERTIFICATION_NAME&name=<%= encodeURIComponent(cert.courseName) %>&certUrl=<%= encodeURIComponent(`http://localhost:3000/verify/${cert.id}`) %>&organizationName=<%= encodeURIComponent('أكاديمية العرب التقنية') %>&issueMonth=<%= new Date().getMonth() + 1 %>&issueYear=<%= new Date().getFullYear() %>" 
                               target="_blank"
                               class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 transition text-sm flex items-center justify-center gap-2">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/>
                                </svg>
                                إضافة إلى LinkedIn
                            </a>
                            
                            <!-- رابط التحقق -->
                            <div class="mt-3 p-3 bg-gray-100 rounded-lg border">
                                <div class="flex items-center gap-2 mb-2">
                                    <svg class="w-4 h-4 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M10.59 13.41c.41.39.41 1.03 0 1.42-.39.39-1.03.39-1.42 0a5.003 5.003 0 0 1 0-7.07l3.54-3.54a5.003 5.003 0 0 1 7.07 0 5.003 5.003 0 0 1 0 7.07l-1.49 1.49c.01-.82-.12-1.64-.4-2.42l.47-.48a2.982 2.982 0 0 0 0-4.24 2.982 2.982 0 0 0-4.24 0l-3.53 3.53a2.982 2.982 0 0 0 0 4.24zm2.82-4.24c.39-.39 1.03-.39 1.42 0a5.003 5.003 0 0 1 0 7.07l-3.54 3.54a5.003 5.003 0 0 1-7.07 0 5.003 5.003 0 0 1 0-7.07l1.49-1.49c-.01.82.12 1.64.4 2.42l-.47.48a2.982 2.982 0 0 0 0 4.24 2.982 2.982 0 0 0 4.24 0l3.53-3.53a2.982 2.982 0 0 0 0-4.24z"/>
                                    </svg>
                                    <span class="text-sm font-medium text-gray-700">رابط التحقق</span>
                                </div>
                                <div onclick="copyVerificationLink('<%= cert.id %>')" 
                                     class="bg-white p-2 rounded border text-sm font-mono text-gray-800 break-all cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all duration-200 select-all">
                                    http://localhost:3000/verify/<%= cert.id %>
                                </div>
                                <div class="text-xs text-gray-500 mt-1 text-center">
                                    اضغط لنسخ الرابط للمشاركة
                                </div>
                            </div>
                            
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } %>
    </div>

    <%- include('partials/footer') %>
    
    <!-- Professional Notification System -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <script>
        // Professional Notification System
        class NotificationSystem {
            constructor() {
                this.container = document.getElementById('notification-container');
            }

            show(message, type = 'info', duration = 5000) {
                const notification = document.createElement('div');
                notification.className = `notification notification-${type}`;
                
                const icon = this.getIcon(type);
                const colors = this.getColors(type);
                
                notification.innerHTML = `
                    <div class="flex items-center p-4 rounded-lg shadow-lg border-r-4 ${colors.bg} ${colors.border} max-w-md">
                        <div class="flex-shrink-0">
                            ${icon}
                        </div>
                        <div class="mr-3 flex-1">
                            <p class="text-sm font-medium ${colors.text}">${message}</p>
                        </div>
                        <button class="flex-shrink-0 ${colors.text} hover:opacity-75" onclick="this.parentElement.parentElement.remove()">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                            </svg>
                        </button>
                    </div>
                `;
                
                this.container.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, duration);
                
                return notification;
            }

            getIcon(type) {
                const icons = {
                    success: '<svg class="w-5 h-5 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>',
                    error: '<svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>',
                    warning: '<svg class="w-5 h-5 text-yellow-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>',
                    info: '<svg class="w-5 h-5 text-blue-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path></svg>'
                };
                return icons[type] || icons.info;
            }

            getColors(type) {
                const colors = {
                    success: { bg: 'bg-green-50', border: 'border-green-400', text: 'text-green-800' },
                    error: { bg: 'bg-red-50', border: 'border-red-400', text: 'text-red-800' },
                    warning: { bg: 'bg-yellow-50', border: 'border-yellow-400', text: 'text-yellow-800' },
                    info: { bg: 'bg-blue-50', border: 'border-blue-400', text: 'text-blue-800' }
                };
                return colors[type] || colors.info;
            }

            success(message, duration) { return this.show(message, 'success', duration); }
            error(message, duration) { return this.show(message, 'error', duration); }
            warning(message, duration) { return this.show(message, 'warning', duration); }
            info(message, duration) { return this.show(message, 'info', duration); }
        }

        // Global notification system
        window.notifications = new NotificationSystem();


        function copyLink(link) {
            navigator.clipboard.writeText(link).then(() => {
                notifications.success('تم نسخ الرابط بنجاح!');
            }).catch(() => {
                notifications.error('فشل في نسخ الرابط');
            });
        }
        
        function copyVerificationLink(certificateId) {
            const verificationUrl = `http://localhost:3000/verify/${certificateId}`;
            
            // إنشاء عنصر textarea مخفي
            const textArea = document.createElement("textarea");
            textArea.value = verificationUrl;
            textArea.style.position = "fixed";
            textArea.style.left = "-999999px";
            textArea.style.top = "-999999px";
            document.body.appendChild(textArea);
            
            try {
                // تحديد النص ونسخه
                textArea.focus();
                textArea.select();
                const successful = document.execCommand('copy');
                
                // إزالة العنصر المؤقت
                document.body.removeChild(textArea);
                
                if (successful) {
                    notifications.success('تم نسخ رابط التحقق بنجاح!');
                } else {
                    notifications.error('فشل في نسخ الرابط');
                }
            } catch (err) {
                notifications.error('فشل في نسخ الرابط');
            }
        }

        // Generate and download certificate
        async function generateAndDownloadCertificate(certificateId) {
            try {
                notifications.info('جاري توليد الشهادة...');
                
                // Check if certificate exists in localStorage
                const existingCertificate = window.certificateGenerator.getCertificate(certificateId);
                if (existingCertificate) {
                    // Download existing certificate
                    await window.certificateGenerator.downloadAsPDF(certificateId);
                    notifications.success('تم تحميل الشهادة بنجاح!');
                    return;
                }
                
                // Get certificate data from server
                const response = await fetch('/api/certificate/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ courseId: certificateId })
                });
                
                const result = await response.json();
                
                if (!result.success) {
                    throw new Error(result.error || 'فشل في الحصول على بيانات الشهادة');
                }
                
                // Generate certificate in browser
                await window.certificateGenerator.generateCertificate(result.certificateData);
                
                // Upload to server
                await window.certificateGenerator.uploadCertificate(certificateId);
                
                // Download as PDF
                await window.certificateGenerator.downloadAsPDF(certificateId);
                
                notifications.success('تم توليد وتحميل الشهادة بنجاح!');
                
            } catch (error) {
                console.error('Certificate generation error:', error);
                notifications.error('فشل في توليد الشهادة: ' + error.message);
            }
        }




    </script>
</body>
</html>