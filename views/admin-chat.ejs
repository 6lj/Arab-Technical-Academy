<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Øª - Ø£ÙƒØ§Ø¯ÙŠÙ…ÙŠØ© Ø§Ù„Ø¹Ø±Ø¨ Ø§Ù„ØªÙ‚Ù†ÙŠØ©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        
        .chat-message {
            display: flex;
            flex-direction: column;
            margin-bottom: 1rem;
        }
        
        .chat-message.sent {
            align-items: flex-end;
        }
        
        .chat-message.received {
            align-items: flex-start;
        }
        
    .chat-sender {
        font-size: 0.75rem;
        color: #000000;
        margin-bottom: 0.25rem;
    }
    
    .chat-text {
        background: #e5e7eb;
        padding: 0.5rem 0.75rem;
        border-radius: 0.75rem;
        max-width: 80%;
        word-wrap: break-word;
        color: #000000;
    }
    
    .chat-message.sent .chat-text {
        background: #3b82f6;
        color: white;
    }
    
    .chat-timestamp {
        font-size: 0.625rem;
        color: #000000;
        margin-top: 0.25rem;
    }
    
    /* Force all text to be black */
    body, h1, h2, h3, p, span, div, input, select, button {
        color: #000000 !important;
    }
    
    /* Input field text */
    input[type="text"], select {
        color: #000000 !important;
    }
    
    /* Placeholder text */
    input::placeholder {
        color: #6b7280 !important;
    }
    
    /* Enhanced select styling */
    #chatRecipient {
        background-image: none !important;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    #chatRecipient:hover {
        border-color: #3b82f6;
        box-shadow: 0 0 0 1px #3b82f6;
    }
    
    #chatRecipient:focus {
        border-color: #3b82f6;
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
    }
    
    /* Customer list enhancements */
    .customer-item {
        transition: all 0.2s ease;
    }
    
    .customer-item:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    /* New message indicator */
    .new-message {
        animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.7; }
    }
    </style>
</head>
<body class="bg-gray-50">
    <%- include('partials/header') %>
    
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h1 class="text-3xl font-bold text-gray-800">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø´Ø§Øª ÙˆØ§Ù„Ø¯Ø¹Ù…</h1>
                <a href="/admin/dashboard" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©
                </a>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <!-- Chat Messages -->
                <div class="lg:col-span-2">
                    <div class="bg-gray-50 rounded-lg p-4 h-96 overflow-y-auto" id="chatMessages">
                        <!-- Messages will be loaded here -->
                    </div>
                    
                    <!-- Chat Form -->
                    <form id="chatForm" class="mt-4">
                        <div class="flex gap-2">
                            <div class="relative">
                                <select id="chatRecipient" class="appearance-none bg-white px-4 py-2 pr-8 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 text-gray-700 min-w-[200px]">
                                    <option value="all" selected>ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            <input type="text" 
                                   id="chatMessage" 
                                   placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯Ùƒ Ù‡Ù†Ø§..." 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                                   required>
                            <button type="submit" 
                                    class="submit-btn bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition relative">
                                <span class="btn-text">Ø¥Ø±Ø³Ø§Ù„</span>
                                <div class="loading hidden">
                                    <svg class="animate-spin w-4 h-4" fill="none" viewBox="0 0 24 24">
                                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                    </svg>
                                </div>
                                <div class="success-message hidden text-green-500 text-sm">ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„!</div>
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- Customer List -->
                <div>
                    <h3 class="text-lg font-semibold mb-4">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</h3>
                    <div id="customerList" class="space-y-2">
                        <!-- Customer list will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const devUserCode = 'admin@academy.com';
        const currentViewerCode = devUserCode;
        const isDev = true;

        function formatSaudiTime(timestamp) {
            const date = new Date(timestamp);
            date.setHours(date.getHours() + 3); 
            
            const hours = date.getHours().toString().padStart(2, '0');
            const minutes = date.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }
        
        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return 'Ø§Ù„Ø¢Ù†';
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} Ø¯Ù‚ÙŠÙ‚Ø©`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} Ø³Ø§Ø¹Ø©`;
            return `${Math.floor(diffInSeconds / 86400)} ÙŠÙˆÙ…`;
        }

        function updateRecipientList(forceUpdate = false) {
            fetch('/api/chat-messages')
                .then(response => response.json())
                .then(data => {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                    const currentMessages = JSON.stringify(data.messages);
                    if (!forceUpdate && window.lastMessages === currentMessages) {
                        return; // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø©ØŒ Ù„Ø§ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ­Ø¯ÙŠØ«
                    }
                    window.lastMessages = currentMessages;
                    // Get unique senders with their message counts and last message time
                    const senderData = {};
                    const now = new Date();
                    
                    data.messages
                        .filter(msg => msg.recipient === 'admin@academy.com' || msg.sender === 'admin@academy.com')
                        .forEach(msg => {
                            const sender = msg.sender === 'admin@academy.com' ? msg.recipient : msg.sender;
                            if (sender !== 'admin@academy.com') {
                                if (!senderData[sender]) {
                                    senderData[sender] = {
                                        email: sender,
                                        count: 0,
                                        lastMessage: null,
                                        unreadCount: 0,
                                        isNew: false
                                    };
                                }
                                senderData[sender].count++;
                                
                                // Check if message is from customer (unread by admin)
                                if (msg.sender !== 'admin@academy.com') {
                                    senderData[sender].unreadCount++;
                                }
                                
                                if (!senderData[sender].lastMessage || new Date(msg.timestamp) > new Date(senderData[sender].lastMessage)) {
                                    senderData[sender].lastMessage = msg.timestamp;
                                    // Mark as new if last message is within last 5 minutes
                                    const messageTime = new Date(msg.timestamp);
                                    senderData[sender].isNew = (now - messageTime) < 5 * 60 * 1000;
                                }
                            }
                        });
                    
                    // Sort by last message time (most recent first)
                    const sortedSenders = Object.values(senderData)
                        .sort((a, b) => new Date(b.lastMessage) - new Date(a.lastMessage));
                    
                    const chatRecipient = document.getElementById('chatRecipient');
                    const savedValue = localStorage.getItem('adminSelectedRecipient');
                    const currentValue = savedValue || window.selectedRecipient || chatRecipient.value; // Ø§Ø³ØªØ®Ø¯Ø§Ù… localStorage Ø£ÙˆÙ„Ø§Ù‹
                    
                    chatRecipient.innerHTML = '<option value="all">ğŸ‘¥ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡</option>';
                    
                    sortedSenders.forEach(sender => {
                        const option = document.createElement('option');
                        option.value = sender.email;
                        
                        // Format last message time
                        const lastMessageTime = new Date(sender.lastMessage);
                        const timeAgo = getTimeAgo(lastMessageTime);
                        
                        const newIndicator = sender.isNew ? 'ğŸ†• ' : '';
                        const unreadIndicator = sender.unreadCount > 0 ? ` (${sender.unreadCount} Ø¬Ø¯ÙŠØ¯)` : '';
                        option.textContent = `${newIndicator}ğŸ“§ ${sender.email} (${sender.count} Ø±Ø³Ø§Ù„Ø©)${unreadIndicator} - ${timeAgo}`;
                        chatRecipient.appendChild(option);
                    });
                    
                    // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© Ù…Ø³Ø¨Ù‚Ø§Ù‹ Ù…Ù† localStorage
                    if (currentValue && chatRecipient.querySelector(`option[value="${currentValue}"]`)) {
                        chatRecipient.value = currentValue;
                        window.selectedRecipient = currentValue;
                        localStorage.setItem('adminSelectedRecipient', currentValue);
                    } else if (currentValue && currentValue !== 'all') {
                        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ù„Ù… ÙŠØ¹Ø¯ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ø£Ø¶ÙÙ‡ ÙƒØ®ÙŠØ§Ø± Ù…Ø¤Ù‚Øª
                        const tempOption = document.createElement('option');
                        tempOption.value = currentValue;
                        tempOption.textContent = `ğŸ“§ ${currentValue} (ØºÙŠØ± Ù…ØªØµÙ„)`;
                        tempOption.style.color = '#6b7280';
                        chatRecipient.insertBefore(tempOption, chatRecipient.firstChild.nextSibling);
                        chatRecipient.value = currentValue;
                        window.selectedRecipient = currentValue;
                        localStorage.setItem('adminSelectedRecipient', currentValue);
                    } else {
                        chatRecipient.value = 'all';
                        window.selectedRecipient = 'all';
                        localStorage.setItem('adminSelectedRecipient', 'all');
                    }
                    
                    // Update customer list
                    const customerList = document.getElementById('customerList');
                    const currentSelectedCustomer = customerList.querySelector('.bg-blue-100'); // Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ Ø­Ø§Ù„ÙŠØ§Ù‹
                    const selectedEmail = currentSelectedCustomer ? 
                        currentSelectedCustomer.querySelector('.font-medium').textContent.replace('ğŸ“§ ', '').replace('ğŸ†• ', '') : null;
                    
                    customerList.innerHTML = '';
                    
                    if (sortedSenders.length === 0) {
                        customerList.innerHTML = '<p class="text-gray-500 text-sm">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù…Ù„Ø§Ø¡</p>';
                    } else {
                        sortedSenders.forEach(sender => {
                            const customerDiv = document.createElement('div');
                            customerDiv.className = 'customer-item bg-gray-100 p-3 rounded-lg cursor-pointer hover:bg-gray-200 transition mb-2';
                            
                            const lastMessageTime = new Date(sender.lastMessage);
                            const timeAgo = getTimeAgo(lastMessageTime);
                            
                            const newIndicator = sender.isNew ? 'ğŸ†• ' : '';
                            const unreadIndicator = sender.unreadCount > 0 ? ` (${sender.unreadCount} Ø¬Ø¯ÙŠØ¯)` : '';
                            
                            customerDiv.innerHTML = `
                                <div class="flex items-center justify-between">
                                    <div class="font-medium text-sm">${newIndicator}ğŸ“§ ${sender.email}</div>
                                    <div class="text-xs text-gray-500">${timeAgo}</div>
                                </div>
                                <div class="text-xs text-gray-500 mt-1">${sender.count} Ø±Ø³Ø§Ù„Ø©${unreadIndicator}</div>
                            `;
                            
                            // Add visual indicator for new/unread messages
                            if (sender.isNew || sender.unreadCount > 0) {
                                customerDiv.classList.add('ring-2', 'ring-blue-400', 'bg-blue-50');
                                if (sender.isNew) {
                                    customerDiv.classList.add('new-message');
                                }
                            }
                            
                            // Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ø­Ø¯Ø¯Ø§Ù‹ Ù…Ø³Ø¨Ù‚Ø§Ù‹
                            if (selectedEmail === sender.email) {
                                customerDiv.classList.remove('bg-gray-100');
                                customerDiv.classList.add('bg-blue-100', 'ring-2', 'ring-blue-400');
                            }
                            
                            customerDiv.addEventListener('click', () => {
                                // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ±
                                customerList.querySelectorAll('.customer-item').forEach(item => {
                                    item.classList.remove('bg-blue-100', 'ring-2', 'ring-blue-400');
                                    item.classList.add('bg-gray-100');
                                });
                                
                                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯
                                customerDiv.classList.remove('bg-gray-100');
                                customerDiv.classList.add('bg-blue-100', 'ring-2', 'ring-blue-400');
                                
                                chatRecipient.value = sender.email;
                                console.log(`ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©: ${sender.email}`);
                                updateChatMessages();
                                
                                // Ø­ÙØ¸ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ localStorage
                                window.selectedRecipient = sender.email;
                                localStorage.setItem('adminSelectedRecipient', sender.email);
                            });
                            customerList.appendChild(customerDiv);
                        });
                    }
                })
                .catch(err => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø²Ø¨Ø§Ø¦Ù†:', err);
                });
        }

        function updateChatMessages() {
            const recipient = document.getElementById('chatRecipient').value;
            console.log(`ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„Ù„Ø¹Ù…ÙŠÙ„: ${recipient}`);
            
            fetch('/api/chat-messages')
                .then(response => response.json())
                .then(data => {
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© Ù‚Ø¨Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«
                    const currentMessages = JSON.stringify(data.messages);
                    const currentRecipient = document.getElementById('chatRecipient').value;
                    
                    // ØªØ­Ø¯ÙŠØ« Ø¥Ø°Ø§ ØªØºÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ùˆ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                    if (window.lastChatMessages === currentMessages && window.lastRecipient === currentRecipient) {
                        return; // Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ„Ø§ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„Ø¹Ù…ÙŠÙ„
                    }
                    
                    window.lastChatMessages = currentMessages;
                    window.lastRecipient = currentRecipient;
                    
                    const chatMessages = document.getElementById('chatMessages');
                    chatMessages.innerHTML = '';
                    let filteredMessages = data.messages;

                    if (recipient !== 'all') {
                        // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙ‚Ø·
                        filteredMessages = data.messages.filter(
                            msg => (msg.sender === recipient && msg.recipient === 'admin@academy.com') || 
                                   (msg.sender === 'admin@academy.com' && msg.recipient === recipient)
                        );
                        console.log(`Ø¹Ø±Ø¶ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„: ${recipient}, Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${filteredMessages.length}`);
                    } else {
                        // Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©
                        filteredMessages = data.messages.filter(
                            msg => msg.sender === 'admin@academy.com' || msg.recipient === 'admin@academy.com'
                        );
                        console.log(`Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„: ${filteredMessages.length}`);
                    }

                    filteredMessages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

                    filteredMessages.forEach(msg => {
                        const messageElement = document.createElement('div');
                        messageElement.className = `chat-message ${msg.sender === 'admin@academy.com' ? 'sent' : 'received'}`;
                        const displaySender = msg.sender === 'admin@academy.com' ? 'Ø£Ù†Øª (Ø§Ù„Ø¯Ø¹Ù…)' : msg.sender;
                        const recipientText = msg.recipient !== 'admin@academy.com' ? `(Ø¥Ù„Ù‰ ${msg.recipient})` : '';
                        
                        const saudiTime = formatSaudiTime(msg.timestamp);
                        
                        messageElement.innerHTML = `
                            <span class="chat-sender">${displaySender} ${recipientText}</span>
                            <span class="chat-text">${msg.text}</span>
                            <span class="chat-timestamp">${saudiTime}</span>
                        `;
                        chatMessages.appendChild(messageElement);
                    });
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø±Ø³Ø§Ù„Ø© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„
                    if (filteredMessages.length === 0) {
                        const noMessagesDiv = document.createElement('div');
                        noMessagesDiv.className = 'text-center text-gray-500 py-8';
                        noMessagesDiv.innerHTML = `
                            <div class="text-lg mb-2">ğŸ’¬</div>
                            <div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ ${recipient === 'all' ? 'Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡' : recipient}</div>
                        `;
                        chatMessages.appendChild(noMessagesDiv);
                    }

                    // Auto scroll to bottom
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                })
                .catch(err => {
                    console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„:', err);
                });
        }

        // Chat form submission
        document.getElementById('chatForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('chatMessage').value.trim();
            const recipient = document.getElementById('chatRecipient').value;

            if (!text) {
                return;
            }
            
            if (recipient === 'all') {
                console.log('Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡');
                return;
            }
            
            console.log(`Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø¹Ù…ÙŠÙ„: ${recipient}`);

            const submitBtn = document.querySelector('.submit-btn');
            const btnText = document.querySelector('.btn-text');
            const loading = document.querySelector('.loading');
            const successMessage = document.querySelector('.success-message');

            btnText.style.opacity = '0';
            loading.style.display = 'block';
            submitBtn.disabled = true;

            try {
                const response = await fetch('/api/chat-messages', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        sender: 'admin@academy.com', 
                        text, 
                        recipient 
                    })
                });

                if (!response.ok) {
                    throw new Error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©');
                }

                loading.style.display = 'none';
                successMessage.style.display = 'block';
                document.getElementById('chatForm').reset();

                updateChatMessages();
                updateRecipientList();

                setTimeout(() => {
                    btnText.style.opacity = '1';
                    submitBtn.disabled = false;
                    successMessage.style.display = 'none';
                }, 2000);

            } catch (err) {
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©:', err);
                btnText.style.opacity = '1';
                submitBtn.disabled = false;
                loading.style.display = 'none';
            }
        });

        // Event listener for select change
        document.getElementById('chatRecipient').addEventListener('change', (e) => {
            const selectedValue = e.target.value;
            console.log(`ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¥Ù„Ù‰: ${selectedValue}`);
            localStorage.setItem('adminSelectedRecipient', selectedValue);
            window.selectedRecipient = selectedValue;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„ØªØ­Ø¯ÙŠØ«
            window.lastChatMessages = null;
            window.lastRecipient = null;
            
            updateChatMessages();
        });

        // Event listeners for chat window - Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¢Ù…Ù†Ø©
        const chatButton = document.getElementById('chatButton');
        const closeChat = document.getElementById('closeChat');
        
        if (chatButton) {
            chatButton.addEventListener('click', () => {
                const chatWindow = document.getElementById('chatWindow');
                if (chatWindow) {
                    chatWindow.classList.remove('hidden');
                    localStorage.setItem('adminChatOpen', 'true');
                }
            });
        }
        
        if (closeChat) {
            closeChat.addEventListener('click', () => {
                const chatWindow = document.getElementById('chatWindow');
                if (chatWindow) {
                    chatWindow.classList.add('hidden');
                    localStorage.setItem('adminChatOpen', 'false');
                }
            });
        }

        // Initialize
        // ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± Ø´Ø®Øµ ØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡ Ù…Ù† localStorage
        const savedRecipient = localStorage.getItem('adminSelectedRecipient');
        if (savedRecipient) {
            window.selectedRecipient = savedRecipient;
            console.log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸: ${savedRecipient}`);
        }
        
        // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø§Øª Ù…Ù† localStorage
        const chatOpen = localStorage.getItem('adminChatOpen');
        if (chatOpen === 'true') {
            const chatWindow = document.getElementById('chatWindow');
            if (chatWindow) {
                chatWindow.classList.remove('hidden');
            }
        }
        
        updateRecipientList(true); // ØªØ­Ø¯ÙŠØ« Ø£ÙˆÙ„ÙŠ
        updateChatMessages();
        
        // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 3 Ø«ÙˆØ§Ù†Ù
        setInterval(() => {
            updateChatMessages();
            updateRecipientList();
        }, 3000);
    </script>
</body>
</html>
